//This is a common technology for malware to use packer software like UPX to compress and anti-decompress by UPX

#include"../../include/fast_io.h"
#include"../../include/fast_io_device.h"

int main(int argc,char** argv)
try
{
	if(argc<3)
	{
		println(fast_io::err,u8"Usage: ",*argv,u8" <upx executable> <upx executable out>");
		return 1;
	}
	fast_io::isystem_file file(argv[1]);
	fast_io::ostring ostr;
	transmit(ostr,file);
	auto& str(ostr.str());
	using namespace std::string_view_literals;
	auto upx_characteristic_str(u8"UPX"sv);
	fast_io::obuf ofile(argv[2]);
	for(auto it(str.cbegin());it<str.cend();)
	{
		auto val(std::search(it,str.cend(),
			std::boyer_moore_horspool_searcher(upx_characteristic_str.cbegin(),upx_characteristic_str.cend())));
        //Use BMH search to replace all string UPX to 000
		if(val==str.cend()&&it==str.cbegin())
		{
			println(fast_io::err,u8"Not a UPX executable");//This is not a UPX packed executable
			return 1;
		}
		writes(ofile,it,val);
		print(ofile,u8"000");//write 000
		it=val+3;
	}
}
catch(std::exception const& e)
{
	println(fast_io::err,e);
	return 1;
}